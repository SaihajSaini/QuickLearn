{"version":3,"sources":["../../../../node_modules/@rrweb/types/dist/types.js","../../../shared/storybook-config/preview.ts"],"names":["NodeType","NodeType2","rebuild","pageUrl","URL","window","location","href","pathname","search","strippedUrl","toString","replace","findHtmlNode","node","type","Element","tagName","childNodes","find","childNode","undefined","snapshotFileName","snapshotId","viewport","fileNameParts","join","fetchSnapshot","context","url","id","storyContext","parameters","server","globals","viewportName","width","height","response","fetch","ok","defaultViewport","json","renderToCanvas","element","snapshot","htmlNode","html","doc","document","replaceChild","children","head","innerHTML","showMain","layout"],"mappings":";;;;AAoFA,IAAIA,WAA4B,kBAACC,cAAAA;AAC/BA,YAAUA,UAAU,UAAA,IAAc,CAAA,IAAK;AACvCA,YAAUA,UAAU,cAAA,IAAkB,CAAA,IAAK;AAC3CA,YAAUA,UAAU,SAAA,IAAa,CAAA,IAAK;AACtCA,YAAUA,UAAU,MAAA,IAAU,CAAA,IAAK;AACnCA,YAAUA,UAAU,OAAA,IAAW,CAAA,IAAK;AACpCA,YAAUA,UAAU,SAAA,IAAa,CAAA,IAAK;AACtC,SAAOA;AACT,GAAGD,YAAY,CAAC,CAAA;;;ACzFhB,SAASE,eAAe;AAExB,IAAMC,UAAU,IAAIC,IAAIC,OAAOC,SAASC,IAAI;AAC5CJ,QAAQK,WAAW;AACnBL,QAAQM,SAAS;AACjB,IAAMC,cAAcP,QAAQQ,SAAQ,EAAGC,QAAQ,OAAO,EAAA;AAOtD,IAAMC,eAAe,wBAACC,SAAAA;AACpB,MAAIA,KAAKC,SAASf,SAASgB,WAAWF,KAAKG,YAAY,QAAQ;AAC7D,WAAOH;EACT;AAEA,MAAI,gBAAgBA,MAAM;AACxB,WAAOA,KAAKI,WAAWC,KAAK,CAACC,cAAAA;AAC3B,aAAOP,aAAaO,SAAAA;IACtB,CAAA;EACF;AAEA,SAAOC;AACT,GAZqB;AAerB,SAASC,iBAAiBC,YAAoBC,UAAgB;AAC5D,QAAMC,gBAAgB;IAACF;IAAYC;IAAU;;AAC7C,SAAOC,cAAcC,KAAK,GAAA;AAC5B;AAHSJ;AAKT,eAAeK,cAAcC,SAAsC;AACjE,QAAM,EAAEC,KAAKC,GAAE,IAAKF,QAAQG,aAAaC,WAAWC;AACpD,QAAM,EAAET,SAAQ,IAAKI,QAAQG,aAAaG;AAG1C,MAAIC;AACJ,MAAI,OAAOX,aAAa,UAAU;AAChCW,mBAAeX;EACjB,OAAO;AAELW,mBAAe,IAAIX,SAASY,KAAK,IAAIZ,SAASa,MAAM;EACtD;AAEA,MAAIC,WAAW,MAAMC,MAAM,GAAGV,GAAAA,IAAOP,iBAAiBQ,IAAIK,YAAAA,CAAAA,EAAe;AACzE,MAAI,CAACG,SAASE,IAAI;AAGhB,UAAM,EAAEC,gBAAe,IAAKb,QAAQG,aAAaC,WAAWR;AAC5Dc,eAAW,MAAMC,MAAM,GAAGV,GAAAA,IAAOP,iBAAiBQ,IAAIW,eAAAA,CAAAA,EAAkB;EAC1E;AAEA,SAAOH,SAASI,KAAI;AACtB;AAtBef;AAwBf,IAAMgB,iBAAiD,8BAAOf,SAASgB,YAAAA;AACrE,QAAMC,WAAW,MAAMlB,cAAcC,OAAAA;AAGrC,QAAMkB,WAAWjC,aAAagC,QAAAA;AAQ9B,QAAME,OAAQ,MAAM7C,QAAQ4C,UAAU;IAAEE,KAAKC;EAAS,CAAA;AAGtDA,WAASC,aAAaH,MAAME,SAASE,SAAS,CAAA,CAAE;AAOhDF,WAASG,KAAKC,aACZ;AAEFzB,UAAQ0B,SAAQ;AAChB,SAAO,MAAA;EAAO;AAChB,GA3BuD;AA6BvD,IAAA,kBAAe;EACbX;EACAX,YAAY;IACVC,QAAQ;MAAEJ,KAAKnB;IAAY;IAC3B6C,QAAQ;EACV;AACF","sourcesContent":["var EventType = /* @__PURE__ */ ((EventType2) => {\n  EventType2[EventType2[\"DomContentLoaded\"] = 0] = \"DomContentLoaded\";\n  EventType2[EventType2[\"Load\"] = 1] = \"Load\";\n  EventType2[EventType2[\"FullSnapshot\"] = 2] = \"FullSnapshot\";\n  EventType2[EventType2[\"IncrementalSnapshot\"] = 3] = \"IncrementalSnapshot\";\n  EventType2[EventType2[\"Meta\"] = 4] = \"Meta\";\n  EventType2[EventType2[\"Custom\"] = 5] = \"Custom\";\n  EventType2[EventType2[\"Plugin\"] = 6] = \"Plugin\";\n  return EventType2;\n})(EventType || {});\nvar IncrementalSource = /* @__PURE__ */ ((IncrementalSource2) => {\n  IncrementalSource2[IncrementalSource2[\"Mutation\"] = 0] = \"Mutation\";\n  IncrementalSource2[IncrementalSource2[\"MouseMove\"] = 1] = \"MouseMove\";\n  IncrementalSource2[IncrementalSource2[\"MouseInteraction\"] = 2] = \"MouseInteraction\";\n  IncrementalSource2[IncrementalSource2[\"Scroll\"] = 3] = \"Scroll\";\n  IncrementalSource2[IncrementalSource2[\"ViewportResize\"] = 4] = \"ViewportResize\";\n  IncrementalSource2[IncrementalSource2[\"Input\"] = 5] = \"Input\";\n  IncrementalSource2[IncrementalSource2[\"TouchMove\"] = 6] = \"TouchMove\";\n  IncrementalSource2[IncrementalSource2[\"MediaInteraction\"] = 7] = \"MediaInteraction\";\n  IncrementalSource2[IncrementalSource2[\"StyleSheetRule\"] = 8] = \"StyleSheetRule\";\n  IncrementalSource2[IncrementalSource2[\"CanvasMutation\"] = 9] = \"CanvasMutation\";\n  IncrementalSource2[IncrementalSource2[\"Font\"] = 10] = \"Font\";\n  IncrementalSource2[IncrementalSource2[\"Log\"] = 11] = \"Log\";\n  IncrementalSource2[IncrementalSource2[\"Drag\"] = 12] = \"Drag\";\n  IncrementalSource2[IncrementalSource2[\"StyleDeclaration\"] = 13] = \"StyleDeclaration\";\n  IncrementalSource2[IncrementalSource2[\"Selection\"] = 14] = \"Selection\";\n  IncrementalSource2[IncrementalSource2[\"AdoptedStyleSheet\"] = 15] = \"AdoptedStyleSheet\";\n  IncrementalSource2[IncrementalSource2[\"CustomElement\"] = 16] = \"CustomElement\";\n  return IncrementalSource2;\n})(IncrementalSource || {});\nvar MouseInteractions = /* @__PURE__ */ ((MouseInteractions2) => {\n  MouseInteractions2[MouseInteractions2[\"MouseUp\"] = 0] = \"MouseUp\";\n  MouseInteractions2[MouseInteractions2[\"MouseDown\"] = 1] = \"MouseDown\";\n  MouseInteractions2[MouseInteractions2[\"Click\"] = 2] = \"Click\";\n  MouseInteractions2[MouseInteractions2[\"ContextMenu\"] = 3] = \"ContextMenu\";\n  MouseInteractions2[MouseInteractions2[\"DblClick\"] = 4] = \"DblClick\";\n  MouseInteractions2[MouseInteractions2[\"Focus\"] = 5] = \"Focus\";\n  MouseInteractions2[MouseInteractions2[\"Blur\"] = 6] = \"Blur\";\n  MouseInteractions2[MouseInteractions2[\"TouchStart\"] = 7] = \"TouchStart\";\n  MouseInteractions2[MouseInteractions2[\"TouchMove_Departed\"] = 8] = \"TouchMove_Departed\";\n  MouseInteractions2[MouseInteractions2[\"TouchEnd\"] = 9] = \"TouchEnd\";\n  MouseInteractions2[MouseInteractions2[\"TouchCancel\"] = 10] = \"TouchCancel\";\n  return MouseInteractions2;\n})(MouseInteractions || {});\nvar PointerTypes = /* @__PURE__ */ ((PointerTypes2) => {\n  PointerTypes2[PointerTypes2[\"Mouse\"] = 0] = \"Mouse\";\n  PointerTypes2[PointerTypes2[\"Pen\"] = 1] = \"Pen\";\n  PointerTypes2[PointerTypes2[\"Touch\"] = 2] = \"Touch\";\n  return PointerTypes2;\n})(PointerTypes || {});\nvar CanvasContext = /* @__PURE__ */ ((CanvasContext2) => {\n  CanvasContext2[CanvasContext2[\"2D\"] = 0] = \"2D\";\n  CanvasContext2[CanvasContext2[\"WebGL\"] = 1] = \"WebGL\";\n  CanvasContext2[CanvasContext2[\"WebGL2\"] = 2] = \"WebGL2\";\n  return CanvasContext2;\n})(CanvasContext || {});\nvar MediaInteractions = /* @__PURE__ */ ((MediaInteractions2) => {\n  MediaInteractions2[MediaInteractions2[\"Play\"] = 0] = \"Play\";\n  MediaInteractions2[MediaInteractions2[\"Pause\"] = 1] = \"Pause\";\n  MediaInteractions2[MediaInteractions2[\"Seeked\"] = 2] = \"Seeked\";\n  MediaInteractions2[MediaInteractions2[\"VolumeChange\"] = 3] = \"VolumeChange\";\n  MediaInteractions2[MediaInteractions2[\"RateChange\"] = 4] = \"RateChange\";\n  return MediaInteractions2;\n})(MediaInteractions || {});\nvar ReplayerEvents = /* @__PURE__ */ ((ReplayerEvents2) => {\n  ReplayerEvents2[\"Start\"] = \"start\";\n  ReplayerEvents2[\"Pause\"] = \"pause\";\n  ReplayerEvents2[\"Resume\"] = \"resume\";\n  ReplayerEvents2[\"Resize\"] = \"resize\";\n  ReplayerEvents2[\"Finish\"] = \"finish\";\n  ReplayerEvents2[\"FullsnapshotRebuilded\"] = \"fullsnapshot-rebuilded\";\n  ReplayerEvents2[\"LoadStylesheetStart\"] = \"load-stylesheet-start\";\n  ReplayerEvents2[\"LoadStylesheetEnd\"] = \"load-stylesheet-end\";\n  ReplayerEvents2[\"SkipStart\"] = \"skip-start\";\n  ReplayerEvents2[\"SkipEnd\"] = \"skip-end\";\n  ReplayerEvents2[\"MouseInteraction\"] = \"mouse-interaction\";\n  ReplayerEvents2[\"EventCast\"] = \"event-cast\";\n  ReplayerEvents2[\"CustomEvent\"] = \"custom-event\";\n  ReplayerEvents2[\"Flush\"] = \"flush\";\n  ReplayerEvents2[\"StateChange\"] = \"state-change\";\n  ReplayerEvents2[\"PlayBack\"] = \"play-back\";\n  ReplayerEvents2[\"Destroy\"] = \"destroy\";\n  return ReplayerEvents2;\n})(ReplayerEvents || {});\nvar NodeType = /* @__PURE__ */ ((NodeType2) => {\n  NodeType2[NodeType2[\"Document\"] = 0] = \"Document\";\n  NodeType2[NodeType2[\"DocumentType\"] = 1] = \"DocumentType\";\n  NodeType2[NodeType2[\"Element\"] = 2] = \"Element\";\n  NodeType2[NodeType2[\"Text\"] = 3] = \"Text\";\n  NodeType2[NodeType2[\"CDATA\"] = 4] = \"CDATA\";\n  NodeType2[NodeType2[\"Comment\"] = 5] = \"Comment\";\n  return NodeType2;\n})(NodeType || {});\nexport {\n  CanvasContext,\n  EventType,\n  IncrementalSource,\n  MediaInteractions,\n  MouseInteractions,\n  NodeType,\n  PointerTypes,\n  ReplayerEvents\n};\n//# sourceMappingURL=types.js.map\n","import type { RenderContext, RenderToCanvas, WebRenderer } from '@storybook/types';\nimport type { serializedNodeWithId } from '@rrweb/types';\nimport { NodeType } from '@rrweb/types';\nimport { rebuild } from '@chromaui/rrweb-snapshot';\n\nconst pageUrl = new URL(window.location.href);\npageUrl.pathname = '';\npageUrl.search = '';\nconst strippedUrl = pageUrl.toString().replace(/\\/$/, '');\n\nexport interface RRWebFramework extends WebRenderer {\n  component: undefined;\n  storyResult: Record<string, never>;\n}\n\nconst findHtmlNode = (node: serializedNodeWithId): serializedNodeWithId | undefined => {\n  if (node.type === NodeType.Element && node.tagName === 'html') {\n    return node;\n  }\n\n  if ('childNodes' in node) {\n    return node.childNodes.find((childNode) => {\n      return findHtmlNode(childNode);\n    });\n  }\n\n  return undefined;\n};\n\n// NOTE: This is duplicated in the shared package due to bundling issues\nfunction snapshotFileName(snapshotId: string, viewport: string) {\n  const fileNameParts = [snapshotId, viewport, 'snapshot.json'];\n  return fileNameParts.join('.');\n}\n\nasync function fetchSnapshot(context: RenderContext<RRWebFramework>) {\n  const { url, id } = context.storyContext.parameters.server;\n  const { viewport } = context.storyContext.globals;\n\n  // Viewport seems to be a string or an object\n  let viewportName;\n  if (typeof viewport === 'string') {\n    viewportName = viewport;\n  } else {\n    // NOTE: This is duplicated in the shared package due to bundling issues\n    viewportName = `w${viewport.width}h${viewport.height}`;\n  }\n\n  let response = await fetch(`${url}/${snapshotFileName(id, viewportName)}`);\n  if (!response.ok) {\n    // Possibly a viewport was specified that we haven't captured, or it's the addon's\n    // default of `reset`, so we'll load the default viewport snapshot instead.\n    const { defaultViewport } = context.storyContext.parameters.viewport;\n    response = await fetch(`${url}/${snapshotFileName(id, defaultViewport)}`);\n  }\n\n  return response.json();\n}\n\nconst renderToCanvas: RenderToCanvas<RRWebFramework> = async (context, element) => {\n  const snapshot = await fetchSnapshot(context);\n\n  // The snapshot is a representation of a complete HTML document\n  const htmlNode = findHtmlNode(snapshot);\n\n  // If you rebuild the full snapshot with rrweb (the document) it will replace the\n  // current document and call `document.open()` in the process, which unbinds all event handlers\n  // (and breaks Storybook).\n  // However, if you just rebuild the html element part, it will recreate but not attempt to\n  // insert it in the DOM.\n  // @ts-expect-error rebuild is typed incorreclty, cache and mirror are optional\n  const html = (await rebuild(htmlNode, { doc: document })) as HTMLElement;\n\n  // Now we insert the rebuilt html element in the DOM\n  document.replaceChild(html, document.children[0]);\n\n  // Storybook's WebView will throw an error if it cannot find these two ids in the DOM.\n  // We never render docs (so the #storybook-docs doesn't matter), and our`renderToCanvas`\n  // function is already ignoring the #storybook-root (`element` above), so it doesn't matter where\n  // they are or what they contain.\n  // We make them a script in the head to ensure they don't impact layout.\n  document.head.innerHTML +=\n    '<script id=\"storybook-root\"></script><script id=\"storybook-docs\"></script>';\n\n  context.showMain();\n  return () => {}; // We can't really cleanup\n};\n\nexport default {\n  renderToCanvas,\n  parameters: {\n    server: { url: strippedUrl },\n    layout: 'fullscreen',\n  },\n};\n"]}