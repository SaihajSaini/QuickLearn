"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const h=require("node:crypto"),S=require("import-meta-resolve"),v=require("@spotlightjs/sidecar");var a=typeof document<"u"?document.currentScript:null;const y="@spotlightjs/spotlight",O=7;function c({server:t,module:r=y}={}){const e=S.resolve(r,typeof document>"u"?require("url").pathToFileURL(__filename).href:a&&a.tagName.toUpperCase()==="SCRIPT"&&a.src||new URL("vite-plugin.cjs",document.baseURI).href).slice(O).split("?",1)[0];return t&&t.config.server.fs.allow.push(e),e}const _=new Set(["importPath","integrationNames","port"]);function m(t){const r=Object.fromEntries(Object.entries(t).filter(([i])=>!i.startsWith("_")&&!_.has(i)));let e=JSON.stringify({...r,showTriggerButton:t.showTriggerButton!==!1,injectImmediately:t.injectImmediately!==!1});const n=JSON.stringify({openLastError:!0});return e=`{integrations: [${(t.integrationNames||["sentry"]).map(i=>`Spotlight.${i}(${n})`).join(", ")}], ${e.slice(1)}`,[`import * as Spotlight from ${JSON.stringify(`/@fs${t.importPath||c()}`)};`,`Spotlight.init(${e});`,"window.createErrorOverlay=function createErrorOverlay(err) { Spotlight.openSpotlight(); };"].join(`
`)}async function w(t,r="http://localhost:8969/stream"){var u;if(!t.errors){console.log(t);return}const e=t.errors[0],n=(u=t.pluginCode)==null?void 0:u.split(`
`),o=e.location.lineText,i=n==null?void 0:n.indexOf(o),s=h.randomBytes(16).toString("hex"),l=new Date,d=new URL(r);let p=r;d.pathname.endsWith("/stream")||(p=new URL("/stream",r).href);const f=[{event_id:s,sent_at:l.toISOString()},{type:"event"},{event_id:s,level:"error",platform:"javascript",environment:"development",tags:{runtime:"vite"},timestamp:l.getTime(),exception:{values:[{type:"Error",mechanism:{type:"instrument",handled:!1},value:e.text,stacktrace:{frames:[e?{filename:e.location.file,lineno:e.location.line,colno:e.location.column,context_line:o,pre_context:n==null?void 0:n.slice(0,i),post_context:i!=null&&i>-1?n==null?void 0:n.slice(i+1):void 0}:{filename:t.id}]}}]}}].map(g=>JSON.stringify(g)).join(`
`);return await fetch(p,{method:"POST",body:f,headers:{"Content-Type":"application/x-sentry-envelope"}})}function T(t={}){let r;return{name:"spotlight",apply:"serve",transform(e,n){if(n.endsWith("vite/dist/client/client.mjs"))return`${m({...t,importPath:r})}${e}`},configureServer(e){return v.setupSidecar({port:t.port}),r=c({server:e}),()=>e.middlewares.use(async function(o,i,s,l){if(await w(o,t.sidecarUrl),s.headersSent)return l(o)})}}}exports.buildClientInit=m;exports.default=T;exports.getSpotlightClientModulePath=c;
